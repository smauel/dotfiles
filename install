#! /usr/bin/env bash

declare -a TAPS=()
declare -a BREWS=()
declare -a CASKS=()

# load config from disk. this allows us to update these files for example when the
# user installs a new brew, automatically with aliases
while IFS='' read -r line || [[ -n "${line}" ]]; do TAPS+=(${line}); done < "taps"
while IFS='' read -r line || [[ -n "${line}" ]]; do BREWS+=(${line}); done < "brews"
while IFS='' read -r line || [[ -n "${line}" ]]; do CASKS+=(${line}); done < "casks"

function update_brew {
  which -s brew
  if [[ $? != 0 ]] ; then
    echo 'installing brew...'
    ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  else
    echo 'updating brew...'
    brew update
  fi
}

function install_taps {
  echo 'installing taps...'
  installed_taps=$(brew tap-info --installed)
  for tap in ${TAPS[@]}; do
    if [[ ${installed_taps} != *"${tap}"* ]]; then
      echo " - ${tap}"
      brew tap ${tap}
    fi
  done
}

function install_brews {
  echo 'installing brews...'
  installed_brews=$(brew list)
  for brew in ${BREWS[@]}; do
    if [[ ${installed_brews} != *"${brew}"* ]]; then
      echo " - ${brew}"
      brew install ${brew}
    fi
  done
}

function install_casks {
  echo 'installing casks...'
  installed_casks=$(brew cask list)
  for cask in ${CASKS[@]}; do
    if [[ ${installed_casks} != *"${cask}"* ]]; then
      echo " - ${cask}"
      brew cask install ${cask}
    fi
  done
}

function symlink_dotfiles {
  echo 'symlinking dotfiles...'
  for dotfile in $(find . -name ".*" -type f -not -name ".ssh-config"); do
    echo " - ${dotfile}"
    ln -sf "${PWD}/${dotfile}" "${HOME}/${dotfile}"
  done

  if [[ -d ~/.ssh ]]; then
    ln -sf ".ssh-config" "${HOME}"/.ssh/config
  fi

  echo 'updating spacemacs...'
  [[ ! -d "~/.emacs.d" ]] && git clone https://github.com/syl20bnr/spacemacs ~/.emacs.d || git -C ~/.emacs.d pull
}

function symlink_scripts {
  echo 'installing scripts...'
  for file in bin/*; do
    local script=${file##*/}
    echo " - ${script}"
    ln -sf "${PWD}/bin/${script}" "/usr/local/bin/${script}"
  done
}

case $1 in
    all)
    symlink_dotfiles
    symlink_scripts
    update_brew
    install_taps
    install_brews
    install_casks
    shift
    ;;
    dotfiles)
    symlink_dotfiles
    shift
    ;;
    scripts)
    symlink_scripts
    shift
    ;;
    taps)
    update_brew
    install_taps
    shift
    ;;
    brews)
    update_brew
    install_brews
    shift
    ;;
    casks)
    update_brew
    install_casks
    shift
    ;;
    *)
    echo "usage: $programname [option]"
    echo "  all        install dotfiles, scripts and all brews, taps and casks"
    echo "  dotfiles   install dotfiles into ${HOME}"
    echo "  scripts    install scripts into /usr/local/bin"
    echo "  brews      install brews"
    echo "  taps       install taps"
    echo "  casks      install casks"
    exit 1
    ;;
esac
